### PRD：AIPIC 多维度照片管理工具（Web MVP）

- **文档版本**：v1.0
- **状态**：草案（基于已确认需求/决策整理）
- **目标平台**：Windows 主机本地服务 + 家庭局域网访问（手机/PC 浏览器）
- **目标规模**：约 3 万张照片
- **核心原则**：默认隐私优先、离线优先、可扩展、可审计

---

## 1. 背景与问题陈述
家庭照片分散在手机/相机/硬盘/网盘中，常见痛点：
- **难以统一导入与归档**：来源多、目录乱、重复多。
- **难以检索与回忆**：仅靠文件夹/时间线不足以定位“某个人/某个地点/某段时间”的照片。
- **隐私与长期可用性**：不希望上传公有云，期望本地可控、可备份、可迁移。

本产品旨在提供一个自托管/本地私有化的照片索引与检索系统，跑通“导入 → 索引 → 搜索 → 可视化”的闭环，并为后续智能分析与桌面端做好扩展基础。

---

## 2. 产品目标与成功指标
### 2.1 产品目标（Web MVP）
- **统一导入**：支持从 PC 批量导入/目录扫描导入，支持手机在局域网上传。
- **可管理**：多级分类（相册/目录树）、标签体系、回收站。
- **可检索**：按时间/相册/标签/地点等维度组合筛选，快速定位照片。
- **可视化**：地理分布（点位/热力）与人物关系图谱（弱智能/渐进式）。
- **安全与隐私**：默认必须登录；尽量本地处理；对外网依赖（地图瓦片）可控。

### 2.2 成功指标（建议口径）
- **导入效率**：单机可稳定导入 3 万张，导入过程可恢复、可观察。
- **检索体验**：常见查询在秒级返回（分页/索引/预聚合）。
- **可靠性**：断电/重启后任务可续跑；数据可备份与恢复。
- **安全默认值**：默认需要登录才能浏览/上传；可审计关键操作。

---

## 3. 范围界定
### 3.1 本期（Web MVP）包含
- **用户与权限**：基础登录、管理员（Owner）管理、会话管理。
- **照片导入与存储**：
  - 导入后**复制到库目录**（已确认）。
  - 去重（基于 hash + size 等）。
  - 生成缩略图/预览图。
  - 支持 HEIC：**原文件保留 + 生成 JPG 缩略图/预览**（已确认）。
- **浏览与检索**：照片列表、详情页、筛选/分页。
- **相册与标签**：树形结构、多级分类、打标/移除、批量操作。
- **地图视图**：EXIF GPS 点位 + 热力（瓦片默认外网，可开关配置）。
- **人物（渐进式）**：人脸检测/聚类形成“人物簇”，支持命名、合并/拆分，共现关系图谱。
- **审计与日志**：关键操作记录（导入、删除/恢复、用户变更等）。
- **API 扩展**：提供版本化 REST API（OpenAPI）。

### 3.2 本期不包含（Non-goals）
- 公网部署与多租户 SaaS。
- 高级人脸识别“实名识别”、社交分享、评论等。
- Live Photo（iPhone 实况照片）完整支持（未确认）。
- 云端/在线反向地理编码默认开启（隐私风险高）。
- Win11 原生桌面端（放到二期）。

---

## 4. 用户画像与使用场景
### 4.1 用户画像
- **Owner（家庭管理员）**：安装与初始化、管理账号与设置、备份、库迁移。
- **家庭成员（普通用户）**：浏览/上传/打标，权限受控。

### 4.2 关键场景
- **手机上传**：在家庭 Wi‑Fi 下打开 Web，选择照片批量上传，支持断点续传。
- **硬盘批量导入**：插入相机/移动硬盘，选择目录扫描，导入后自动归档、去重。
- **按人/地/时间找图**：如“去年春节 + 爸爸 + 老家”，快速定位。
- **回收站恢复**：误删后可恢复。

---

## 5. 关键用户流程（MVP）
### 5.1 初始化与登录
1) Owner 启动服务 → 访问初始化页面（首次） → 创建 Owner 账号 → 初始化库目录。
2) 登录后进入照片库主页。

### 5.2 导入（PC）
1) 选择“导入” → 选择本地目录/设备路径。
2) 创建导入任务 → 后台复制 originals、计算 hash、写入 DB。
3) 后台生成缩略图/预览 → 前台可查看导入进度与错误。

### 5.3 上传（手机/浏览器）
1) 选择“上传” → 选择多张照片。
2) 分片上传（断点续传/秒传） → 合并 → 入库 → 生成缩略图。

### 5.4 浏览与管理
- 列表页：按时间线浏览、筛选、批量选中。
- 详情页：查看 EXIF、地点、标签、所属相册、人物簇。
- 相册/标签：树形管理、批量增删。

### 5.5 可视化
- 地图页：点位/热力层，支持按时间/相册/标签过滤。
- 人物关系图：以人物簇为节点，共现为边（权重=共现次数），支持筛选与跳转到照片列表。

---

## 6. 功能需求（按模块）

### 6.1 账号与权限
- **必须**
  - 登录/登出。
  - 用户角色：Owner / Member。
  - Owner 可创建/禁用用户、重置密码。
  - 默认策略：**未登录不可浏览/上传**。
- **可选（后续）**
  - 邀请链接、临时访客、只读模式。

### 6.2 库与存储（Library）
- **库目录结构（固定约定）**
  - `originals/YYYY/MM/`：原文件（按时间分桶）。
  - `thumbs/{size}/`：缩略图（建议 `256`、`1024` 两档）。
  - `db/app.sqlite`：SQLite 数据库。
  - `tmp/uploads/`：分片上传临时目录。
  - `logs/`：日志（可选）。
- **导入策略（已确认）**
  - 导入时复制到库目录，源文件不改动。
  - 去重：hash（sha256/blake3 等）+ size 等辅助。
  - 文件命名：支持 `{hash}.{ext}` 或 `hash_prefix/` 分桶（实现可选）。
  - **原始文件名保留**：数据库中记录用户上传/导入时的原始文件名，便于用户识别与搜索（原始文件名往往包含人工分类信息）。

### 6.3 导入与任务系统
- **必须**
  - 目录扫描导入、单文件导入。
  - 任务状态：queued/running/succeeded/failed/cancelled。
  - 进度展示：已处理数/总数、错误列表。
  - 可恢复：服务重启后任务可继续或可重跑。
- **导入过滤机制（黑名单）**
  - **系统隐藏文件过滤**：
    - `.DS_Store`（macOS 目录服务存储）
    - `Thumbs.db`（Windows 缩略图缓存）
    - `desktop.ini`（Windows 文件夹配置）
    - `.localized`（macOS 本地化标记）
    - `._*`（macOS 资源分支文件，点下划线开头）
  - **文件大小阈值**：过滤小于 10KB 的文件（如表情包、小图标等）。
  - **扩展名白名单**：仅允许常见图片格式（`.jpg`、`.jpeg`、`.png`、`.gif`、`.bmp`、`.webp`、`.heic`、`.heif` 等）。
  - **过滤逻辑流程**：
    ```
    扫描文件 → 
      ├─ 文件名匹配黑名单？→ 是 → 跳过并记录
      ├─ 文件大小 < 10KB？→ 是 → 跳过并记录
      └─ 扩展名在白名单？→ 否 → 跳过并记录
                           → 是 → 加入导入队列
    ```
  - **配置方式**：黑名单规则可通过配置文件或环境变量调整，支持扩展。
  - **过滤日志**：记录被过滤的文件路径与原因，供管理员审查（可选展示）。
- **约束**
  - 重 CPU/IO（缩略图、人脸）必须后台异步，不阻塞请求。

### 6.4 上传（分片/断点续传/秒传）
- **必须**
  - 初始化上传会话（返回 `upload_id`、已存在分片）。
  - 分片上传（按 `partNumber`）。
  - 完成合并并入库。
  - 上传校验：大小、MIME/扩展名白名单、鉴权。
- **建议**
  - 秒传：客户端可先提交 hash，服务端已存在则直接入库引用。

### 6.5 照片浏览与检索
- **必须**
  - 列表分页：时间降序为主。
  - 组合过滤：时间范围、相册、标签、地点（是否有 GPS）、人物簇。
  - 详情页：预览、基础 EXIF、文件信息、来源与导入记录。

### 6.6 相册（多级目录）
- **必须**
  - 树形相册：新增/重命名/移动/删除（软删除可选）。
  - 照片与相册多对多。
  - 批量加入/移除。

### 6.7 标签（智能/手动）
- **必须**
  - 标签树：新增/重命名/合并/删除。
  - 手动打标、批量打标。
- **可选（后续）**
  - 自动标签（来源标记 `manual/auto`，带置信度）。

### 6.8 地理视图（地图/热力）
- **必须**
  - 读取 EXIF GPS 生成点位。
  - 热力聚合接口（支持 bbox/zoom 或时间范围过滤）。
- **隐私与外部依赖**
  - 地图瓦片默认外网（已确认），但需提供配置开关与提示。
  - 默认不做在线反向地理编码（可后续增加可选离线方案）。

### 6.9 人物（人脸聚类 + 关系图谱）
- **必须（渐进式）**
  - 人脸检测 → embedding → 聚类得到人物簇（不要求实名）。
  - 人物簇命名、合并/拆分。
  - 共现关系图谱：同张照片出现即加边，权重累加。
- **隐私**
  - 提供清除人脸特征数据开关（删除 embedding/face 记录）。

### 6.10 回收站与删除
- **必须**
  - 软删除（`deleted_at`）与恢复。
  - Owner 可永久删除（可选延迟清理）。

### 6.11 审计与可观测性
- **必须**
  - 记录关键操作（用户、删除/恢复、导入任务等）。
  - 基本运行日志。

---

## 7. 非功能需求
### 7.1 性能
- 面向 3 万张照片：列表/筛选查询需依赖 DB 索引与分页。
- 缩略图、嵌入向量计算等重任务必须异步。

### 7.2 可靠性与可恢复
- SQLite 开启 WAL（实现建议），避免并发读写阻塞。
- 任务可重试、可断点（至少上传要断点续传）。

### 7.3 安全
- 默认必须登录。
- 密码安全哈希（bcrypt/argon2）。
- 上传限流/大小限制/类型校验。
- API 不暴露真实文件路径（以 `photo_id` 访问）。

### 7.4 隐私
- 尽量本地处理。
- 外网瓦片依赖可一键关闭/替换。
- 人脸特征数据可清除。

### 7.5 兼容性
- 浏览器：主流现代浏览器；手机端可用。
- Windows 主机：服务可作为常驻进程/服务运行（具体方式后续定）。

---

## 8. 信息架构与页面（建议）
- **登录页**
- **首页/照片库**：时间线 + 筛选栏 + 批量操作
- **照片详情**：预览、EXIF、地点、相册、标签、人物
- **导入任务**：任务列表、进度、错误
- **上传页（移动端友好）**
- **相册管理**：树形结构
- **标签管理**：树形结构
- **地图视图**：点位/热力 + 过滤
- **人物**：人物簇列表、人物详情（照片）、关系图谱
- **设置**：库路径、瓦片配置、安全开关、备份提示
- **用户管理（Owner）**

---

## 9. 系统设计（MVP 建议架构）
### 9.1 组件
- **Web 前端**：响应式 UI（PC + 手机）。
- **后端 API**：REST + OpenAPI 文档。
- **任务队列/Worker**：导入、缩略图、人脸分析等异步任务。
- **数据库**：SQLite（后续可迁移到 PostgreSQL）。
- **存储**：文件系统库目录（originals + thumbs）。

### 9.2 数据流（简述）
- 导入/上传 → 临时落盘 → 计算 hash/去重 → originals 入库 → 写 DB → 生成 thumbs → 可视化数据按需计算/缓存。

---

## 10. API 需求（v1 草案）
> 以 `/api/v1` 版本化；返回结构统一（`data`/`error`/`request_id` 等实现自定）。

### 10.1 认证
- `POST /api/v1/auth/login`
- `POST /api/v1/auth/logout`
- `GET /api/v1/users/me`

### 10.2 导入任务
- `POST /api/v1/imports`：创建导入任务（目录/文件列表）
- `GET /api/v1/imports/{id}`：任务状态/进度/错误

### 10.3 上传（分片）
- `POST /api/v1/uploads/init`：初始化，返回 `upload_id`、已存在分片
- `PUT /api/v1/uploads/{upload_id}/part?partNumber=n`：上传分片
- `POST /api/v1/uploads/{upload_id}/complete`：合并并入库

### 10.4 照片
- `GET /api/v1/photos`：筛选分页
- `GET /api/v1/photos/{id}`：详情
- `DELETE /api/v1/photos/{id}`：软删
- `POST /api/v1/photos/{id}/restore`：恢复

### 10.5 相册
- `GET /api/v1/albums/tree`
- `POST /api/v1/albums` / `PATCH /api/v1/albums/{id}` / `DELETE /api/v1/albums/{id}`
- `POST /api/v1/albums/{id}/photos:batchAdd`
- `POST /api/v1/albums/{id}/photos:batchRemove`

### 10.6 标签
- `GET /api/v1/tags/tree`
- `POST /api/v1/tags` / `PATCH /api/v1/tags/{id}` / `DELETE /api/v1/tags/{id}`
- `POST /api/v1/photos/{id}/tags:batchAdd`
- `POST /api/v1/photos/{id}/tags:batchRemove`

### 10.7 地图
- `GET /api/v1/map/heat`：按范围/缩放/过滤返回聚合数据

### 10.8 人物与图谱
- `GET /api/v1/persons`
- `GET /api/v1/persons/{id}/photos`
- `POST /api/v1/persons:merge`
- `POST /api/v1/persons:split`
- `GET /api/v1/graph/cooccurrence`

---

## 11. 数据模型（SQLite 草案）
> 仅定义核心实体与关系，字段可在实现阶段细化。

- `users`：账号、角色、状态
- `sessions`：会话/刷新 token（可选）
- `photos`：文件 hash、大小、MIME、宽高、拍摄时间、GPS、相机信息、软删标记、**原始文件名**（用户上传时的文件名，用于前端展示与搜索）
- `thumbnails`：`photo_id` + `size` + `path`
- `albums` + `album_photos`：树形相册，多对多
- `tags` + `photo_tags`：树形标签，多对多（来源/置信度）
- `imports`：任务状态、进度、错误摘要
- `faces`：`photo_id`、bbox、embedding、质量分
- `persons` + `person_faces`：人物簇与人脸关联
- `audit_logs`：关键操作审计

**关键索引（建议）**
- `photos(taken_at)`、`photos(file_hash)`、`photo_tags(tag_id)`、`album_photos(album_id)`、`faces(photo_id)`、`person_faces(person_id)`。

---

## 12. 里程碑（Sprint 建议）
### Sprint 1（最小闭环）
- 登录/用户（Owner 初始化）
- 库初始化、SQLite
- 上传/导入基础能力
- 缩略图 worker
- 照片列表/详情

### Sprint 2（管理与可靠性）
- 分片续传 + 秒传
- 目录扫描导入增强
- 相册树、标签与筛选
- 回收站
- 审计日志

### Sprint 3（地图可视化）
- 地图点位/热力
- 过滤联动（时间/相册/标签）
- 外网瓦片开关与隐私提示

### Sprint 4（人物与关系图谱）
- 人脸检测/聚类
- 人物簇页与命名
- 共现关系图谱
- 合并/拆分 + 清除特征

---

## 13. 风险与对策
- **性能风险（3 万张）**：分页/索引/预聚合；缩略图与人脸异步；避免全表扫描。
- **隐私风险（地图瓦片外网）**：默认提示 + 开关 + 可替换本地瓦片源。
- **人脸识别争议**：默认本地处理；提供禁用与数据清除；明确说明不做“实名识别”。
- **存储空间压力（复制入库）**：提示空间预估与清理策略；可选“引用模式”后续再加。

---

## 14. 未决问题（后续需要确认）
- 是否需要支持 Live Photo（照片 + 视频对）。
- 是否需要“内网免登录模式”（强烈不建议默认开启）。
- 瓦片服务的默认供应商与隐私提示文案。
- 备份/迁移：是否需要一键导出（库目录 + DB）与校验工具。

---

## 15. 附录：已确认关键决策清单
- **Web MVP 优先**，Win11 原生桌面端二期。
- **部署**：Windows 主机本地服务，家庭局域网访问。
- **规模**：约 3 万张。
- **存储**：导入后复制到库目录。
- **上传**：需要手机访问上传。
- **地图**：默认使用外网瓦片（需提供开关）。
- **HEIC**：原文件入库保留 + 生成 JPG 缩略图/预览。
